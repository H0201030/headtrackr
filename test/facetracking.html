<!doctype html>
<html lang="en">
    <head>
        <title>facetracking</title>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
        <meta charset="utf-8">
        <style>
            body {
                background-color: #f0f0f0;
                margin-left: 10%;
                margin-right: 10%;
                margin-top: 5%;
                width: 40%;
                overflow: hidden;
                font-family: "Helvetica", Arial, Serif;
                position: relative;
            }
        </style>
    </head>
    <body>
        <script src="RecordRTC-together.js"></script>
        <script src="../src/main.js"></script>
        <script src="../src/ccv.js"></script>
        <script src="../src/cascade.js"></script>
        <script src="../src/whitebalance.js"></script>
        <script src="../src/smoother.js"></script>
        <script src="../src/camshift.js"></script>
        <script src="../src/facetrackr.js"></script>
        <script src="../src/ui.js"></script>
        <script src="../src/headposition.js"></script>
        <script src="../src/controllers.js"></script>

        <canvas id="compare" width="320" height="240" style="display:none"></canvas>
        <video id="vid" autoplay loop width="320" height="240"></video>
        <canvas id="overlay" width="320" height="240"></canvas>
        <canvas id="debug" width="320" height="240"></canvas>

        <p id='gUMMessage'></p>
        <p>Status : <span id='headtrackerMessage'></span></p>
        <p>WhiteBalance : <span id="whiteBalance"></span></p>
        <button onclick="getWhiteBalance()">Get WhiteBalance</button>
        <p>
            <input type="button" onclick="htracker.stop();htracker.start();" value="reinitiate facedetection"></input>
            <br/><br/>
            <input type="checkbox" onclick="showProbabilityCanvas()" value="asdfasd"></input>Show probability-map
        </p>

        <script>
            // set up video and canvas elements needed
        var videoInput = document.getElementById('vid');
        var canvasInput = document.getElementById('compare');
        var canvasOverlay = document.getElementById('overlay')
        var debugOverlay = document.getElementById('debug');
        var overlayContext = canvasOverlay.getContext('2d');

        canvasOverlay.style.position = "absolute";
        canvasOverlay.style.top = '0px';
        canvasOverlay.style.zIndex = '100001';
        canvasOverlay.style.display = 'block';

        debugOverlay.style.position = "absolute";
        debugOverlay.style.top = '0px';
        debugOverlay.style.zIndex = '100002';
        debugOverlay.style.display = 'none';

        // recordRTC
        var constraints = { video: true, audio: false };
        var lastVideoFrame;
        var recorder = new RecordRTC({
            enable: constraints,
            videoElem: videoInput,
            canvasElem: canvasInput
        });
        // the face tracking setup
        var htracker = new headtrackr.Tracker({
            calcAngles : false,
            ui : true,
            headPosition : false,
            debug : debugOverlay
        });

        // get user media
        recorder.getMedia(function(stream) {
            recorder.setMedia(stream);
            lastVideoFrame = requestAnimationFrame(recorder.drawVideoFrame.bind(recorder));

            htracker.init(canvasInput);
            htracker.start();
        }, function() {
            console.log("getMedia failed");
        });

        // add some custom messaging
        statusMessages = {
            "whitebalance" : "checking for stability of camera whitebalance",
            "detecting" : "Detecting face",
            "hints" : "Hmm. Detecting the face is taking a long time",
            "redetecting" : "Lost track of face, redetecting",
            "lost" : "Lost track of face",
            "found" : "Tracking face"
        };

        supportMessages = {
            "no getUserMedia" : "Unfortunately, <a href='http://dev.w3.org/2011/webrtc/editor/getusermedia.html'>getUserMedia</a> is not supported in your browser. Try <a href='http://www.opera.com/browser/'>downloading Opera 12</a> or <a href='http://caniuse.com/stream'>another browser that supports getUserMedia</a>. Now using fallback video for facedetection.",
            "no camera" : "No camera found. Using fallback video for facedetection."
        };

        document.addEventListener("headtrackrStatus", function(event) {
            if (event.status in supportMessages) {
                var messagep = document.getElementById('gUMMessage');
                messagep.innerHTML = supportMessages[event.status];
            } else if (event.status in statusMessages) {
                var messagep = document.getElementById('headtrackerMessage');
                messagep.innerHTML = statusMessages[event.status];
            }
        }, true);

        // for each facetracking event received draw rectangle around tracked face on canvas
        document.addEventListener("facetrackingEvent", function( event ) {
            // clear canvas
            overlayContext.clearRect(0,0,640,480);
            // once we have stable tracking, draw rectangle
            if (event.detection == "CS") {
                overlayContext.translate(event.x, event.y)
                overlayContext.rotate(event.angle - (Math.PI/2));
                overlayContext.strokeStyle = "#00CC00";
                overlayContext.strokeRect((-(event.width/2)) >> 0, (-(event.height/2)) >> 0, event.width, event.height);
                overlayContext.rotate((Math.PI/2)-event.angle);
                overlayContext.translate(-event.x, -event.y);

                console.log(event);
            }
        });

        // turn off or on the canvas showing probability
        function showProbabilityCanvas() {
            var debugCanvas = document.getElementById('debug');
            if (debugCanvas.style.display == 'none') {
                debugCanvas.style.display = 'block';
            } else {
                debugCanvas.style.display = 'none';
            }
        }

        function getWhiteBalance() {
            var message = document.getElementById('whiteBalance')
            message.innerHTML += " " + headtrackr.getWhitebalance(canvasInput);
        }
        </script>
    </body>
</html>
